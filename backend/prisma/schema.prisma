generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  name         String
  phone        String
  role         String        @default("CUSTOMER")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  bookings     Booking[]
  rideRequests RideRequest[]
  driverTrips  Trip[]        @relation("DriverTrips")

  @@map("users")
}

model Vehicle {
  id           String   @id @default(uuid())
  name         String
  licensePlate String   @unique
  capacity     Int
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  trips        Trip[]

  @@map("vehicles")
}

model RideRequest {
  id                String     @id @default(uuid())
  customerId        String
  pickupAddress     String
  pickupLat         Float
  pickupLng         Float
  desiredPickupTime DateTime
  dropoffAddress    String
  dropoffLat        Float
  dropoffLng        Float
  returnAddress     String
  returnLat         Float
  returnLng         Float
  desiredReturnTime DateTime
  homeAddress       String
  homeLat           Float
  homeLng           Float
  passengerCount    Int        @default(1)
  specialRequests   String?
  status            String     @default("REQUESTED")
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  bookings          Booking[]
  proposals         Proposal[]
  customer          User       @relation(fields: [customerId], references: [id])

  @@map("ride_requests")
}

model Trip {
  id                 String     @id @default(uuid())
  vehicleId          String
  driverId           String?
  direction          String
  status             String     @default("PLANNED")
  startTime          DateTime
  endTime            DateTime
  totalDistance      Float?
  estimatedDuration  Int?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  currentLat         Float?
  currentLng         Float?
  lastLocationUpdate DateTime?
  bookings           Booking[]
  returnProposals    Proposal[] @relation("ProposalReturnTrip")
  outboundProposals  Proposal[] @relation("ProposalOutboundTrip")
  stops              Stop[]
  driver             User?      @relation("DriverTrips", fields: [driverId], references: [id])
  vehicle            Vehicle    @relation(fields: [vehicleId], references: [id])

  @@map("trips")
}

model Stop {
  id            String    @id @default(uuid())
  tripId        String
  stopType      String
  sequence      Int
  address       String
  latitude      Float
  longitude     Float
  scheduledTime DateTime
  actualTime    DateTime?
  customerId    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  trip          Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@map("stops")
}

model Proposal {
  id                String      @id @default(uuid())
  requestId         String
  status            String      @default("ACTIVE")
  outboundTripId    String?
  pickupTime        DateTime
  dropoffTime       DateTime
  returnTripId      String?
  returnPickupTime  DateTime
  returnDropoffTime DateTime
  estimatedPrice    Float
  expiresAt         DateTime
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  returnTrip        Trip?       @relation("ProposalReturnTrip", fields: [returnTripId], references: [id])
  outboundTrip      Trip?       @relation("ProposalOutboundTrip", fields: [outboundTripId], references: [id])
  request           RideRequest @relation(fields: [requestId], references: [id])

  @@map("proposals")
}

model Booking {
  id              String      @id @default(uuid())
  requestId       String
  customerId      String
  outboundTripId  String?
  returnTripId    String?
  status          String      @default("CONFIRMED")
  totalPrice      Float
  paidAmount      Float       @default(0)
  paymentStatus   String      @default("PENDING")
  transactionId   String?
  cancelledAt     DateTime?
  cancellationFee Float?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  outboundTrip    Trip?       @relation(fields: [outboundTripId], references: [id])
  customer        User        @relation(fields: [customerId], references: [id])
  request         RideRequest @relation(fields: [requestId], references: [id])

  @@map("bookings")
}

model Transaction {
  id              String   @id @default(uuid())
  bookingId       String
  amount          Float
  type            String
  status          String
  isMock          Boolean  @default(true)
  mockReference   String?
  paymentMethod   String?
  pgProvider      String?
  pgTransactionId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("transactions")
}
