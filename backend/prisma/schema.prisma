// Prisma Schema for RETURN MVP
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== 사용자 관리 ==========

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  phone     String
  role      String   @default("CUSTOMER") // CUSTOMER, DRIVER, ADMIN
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 기사 프로필 정보 (DRIVER 역할인 경우에만 사용)
  profileImage  String?  // 프로필 이미지 URL
  rating        Float    @default(5.0)  // 평균 평점
  totalTrips    Int      @default(0)    // 총 운행 횟수
  bio           String?  // 자기소개

  // 친구 초대 & 포인트
  referralCode  String?  // 내 초대 코드
  referredBy    String?  // 나를 초대한 사람의 ID
  points        Int      @default(0)  // 포인트 잔액

  // Relations
  rideRequests RideRequest[]
  bookings     Booking[]
  driverTrips  Trip[]        @relation("DriverTrips")
  receivedReviews Review[]   @relation("DriverReviews")

  @@map("users")
}

// ========== 차량 관리 ==========

model Vehicle {
  id        String   @id @default(cuid())
  name      String   // 예: "스타리아 1호"
  licensePlate String @unique
  capacity  Int      // 정원
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trips Trip[]

  @@map("vehicles")
}

// ========== 예약 요청 ==========

model RideRequest {
  id        String   @id @default(cuid())
  customerId String
  customer  User     @relation(fields: [customerId], references: [id])
  
  // 가는 편 정보
  pickupAddress      String
  pickupLat          Float
  pickupLng          Float
  desiredPickupTime  DateTime
  
  dropoffAddress     String
  dropoffLat         Float
  dropoffLng         Float
  
  // 귀가 편 정보
  returnAddress      String
  returnLat          Float
  returnLng          Float
  desiredReturnTime  DateTime
  
  homeAddress        String
  homeLat            Float
  homeLng            Float
  
  // 추가 정보
  passengerCount     Int      @default(1)
  specialRequests    String?  // 캐리어 등
  
  status    String   @default("REQUESTED") // REQUESTED, PROPOSED, CONFIRMED, CANCELLED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  proposals Proposal[]
  bookings  Booking[]

  @@map("ride_requests")
}

// ========== 운행 (Trip) ==========

model Trip {
  id         String   @id @default(cuid())
  vehicleId  String
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id])
  driverId   String?
  driver     User?    @relation("DriverTrips", fields: [driverId], references: [id])

  direction  String   // OUTBOUND, RETURN
  status     String   @default("PLANNED") // PLANNED, READY, IN_PROGRESS, COMPLETED, CANCELLED

  // 운행 시간
  startTime  DateTime
  endTime    DateTime

  // 메타 정보
  totalDistance Float?     // km
  estimatedDuration Int?    // minutes

  // 실시간 위치 추적
  currentLat         Float?
  currentLng         Float?
  lastLocationUpdate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stops    Stop[]
  bookings Booking[]
  outboundProposals Proposal[] @relation("OutboundProposals")
  returnProposals   Proposal[] @relation("ReturnProposals")

  @@map("trips")
}

// ========== 정거장 (Stop) ==========

model Stop {
  id        String   @id @default(cuid())
  tripId    String
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  
  stopType  String   // PICKUP, DROPOFF
  sequence  Int      // 순서 (1, 2, 3...)
  
  // 위치 정보
  address   String
  latitude  Float
  longitude Float
  
  // 시간 정보
  scheduledTime DateTime
  actualTime    DateTime?
  
  // 고객 정보 (이 Stop에서 픽업/하차할 고객들)
  customerId String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stops")
}

// ========== 제안 (Proposal) ==========

model Proposal {
  id            String      @id @default(cuid())
  requestId     String
  request       RideRequest @relation(fields: [requestId], references: [id])

  status        String      @default("ACTIVE") // ACTIVE, ACCEPTED, REJECTED, EXPIRED

  // 가는 편 정보
  outboundTripId String?
  outboundTrip   Trip?       @relation("OutboundProposals", fields: [outboundTripId], references: [id])
  pickupTime     DateTime
  dropoffTime    DateTime

  // 귀가 편 정보
  returnTripId   String?
  returnTrip     Trip?       @relation("ReturnProposals", fields: [returnTripId], references: [id])
  returnPickupTime  DateTime
  returnDropoffTime DateTime

  // 가격
  estimatedPrice Float

  // 유효 기간
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("proposals")
}

// ========== 확정 예약 (Booking) ==========

model Booking {
  id          String      @id @default(cuid())
  requestId   String
  request     RideRequest @relation(fields: [requestId], references: [id])
  customerId  String
  customer    User        @relation(fields: [customerId], references: [id])
  
  // Trip 연결 (가는 편 + 귀가 편)
  outboundTripId String?
  outboundTrip   Trip?   @relation(fields: [outboundTripId], references: [id])
  returnTripId   String?
  
  status      String      @default("CONFIRMED") // CONFIRMED, IN_TRIP, COMPLETED, NO_SHOW, CANCELLED
  
  // 결제 정보
  totalPrice     Float
  paidAmount     Float    @default(0)
  paymentStatus  String   @default("PENDING")  // PENDING, PAID, REFUNDED
  transactionId  String?  // Mock 또는 실제 결제 ID
  
  // 취소 정보
  cancelledAt    DateTime?
  cancellationFee Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  review Review?

  @@map("bookings")
}

// ========== 리뷰 ==========

model Review {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])
  driverId   String
  driver     User     @relation("DriverReviews", fields: [driverId], references: [id])
  customerId String

  rating     Int      // 1-5 별점
  comment    String?  // 한줄평

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("reviews")
}

// ========== 포인트 내역 ==========

model PointHistory {
  id         String   @id @default(cuid())
  userId     String

  amount     Int      // + 적립, - 사용
  type       String   // REFERRAL_BONUS, REFERRED_BONUS, RIDE_REWARD, USED, EXPIRED
  description String  // 상세 설명

  // 관련 예약 ID (옵션)
  bookingId  String?

  createdAt  DateTime @default(now())

  @@map("point_history")
}

// ========== 결제 내역 ==========

model Transaction {
  id            String   @id @default(cuid())
  bookingId     String
  
  amount        Float
  type          String   // PAYMENT, REFUND, CANCELLATION_FEE
  status        String   // PENDING, COMPLETED, FAILED
  
  // Mock 결제 정보
  isMock        Boolean  @default(true)
  mockReference String?
  
  // 실제 결제 정보 (나중에 사용)
  paymentMethod String?
  pgProvider    String?
  pgTransactionId String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("transactions")
}
